<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Atlântico Golf — Kanban (Refatorado p/ IA)</title>
  <meta name="description" content="Kanban mobile com WhatsApp Share, coluna de Suprimentos, filtros com contagem, diferença Planejado×Real e arquitetura preparada para interface com IA. Com selo inspirador em tarefas finalizadas." />
  <meta name="theme-color" content="#0b2a4a" />
  <style>
    :root{
      --bg:#f6f8fc; --text:#0f172a; --muted:#475569; --brand:#0e3a6d; --brand2:#0b2a4a;
      --card:#ffffff; --border:#d6e0ea; --head:#f1f5f9; --ring:#38bdf8;
      --ok:#16a34a; --warn:#ca8a04; --late:#b91c1c; --block:#9333ea; --exec:#0ea5e9; --recv:#15803d;
      --chip:#e2e8f0; --mono:#111827; --wa:#25D366; --wa-dark:#1EA955;
      --pend:#cbd5e1; /* NOVO: cinza claro para PENDENTES */
      --header-h:92px; --footer-h:84px; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text)}

    header{position:sticky;top:0;z-index:100;display:flex;flex-direction:column;gap:10px;padding:12px 16px;background:linear-gradient(90deg,var(--brand2),var(--brand));color:#fff;box-shadow:0 4px 18px rgba(2,6,23,.18)}
    .head-top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px;min-width:240px}
    .logo{height:42px;width:auto;display:block;object-fit:contain}
    h1{margin:0;font-size:20px}
    .meta{display:flex;flex-direction:column;gap:4px;text-align:right}
    .stamp{font-size:12px;font-weight:700}

    /* Board */
    .board{height:calc(100vh - var(--header-h) - var(--footer-h));display:flex;gap:12px;padding:12px 12px 16px;overflow-x:auto;overflow-y:hidden;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
    .column{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);min-width:300px;max-width:480px;flex:1;display:flex;flex-direction:column;height:100%;overflow:hidden;scroll-snap-align:start;contain:layout paint}
    .column h2{position:sticky;top:0;z-index:10;margin:0;padding:10px 12px;background:var(--head);font-size:16px;font-weight:800;border-bottom:1px solid var(--border);text-align:center}
    .list{flex:1;overflow:auto;padding:10px}

    .card{background:#fff;margin:8px 0;border:1px solid var(--border);border-left:10px solid var(--border);border-radius:12px;padding:12px 12px 10px;box-shadow:0 3px 10px rgba(2,6,23,.06);position:relative}
    .overdue{border-left-color:var(--late)}
    .block{border-left-color:var(--block)} /* BLOQUEADAS: roxo */
    .exec{border-left-color:var(--exec)}
    .done{border-left-color:var(--ok)}
    .soon{border-left-color:var(--warn)}
    .ok{border-left-color:var(--ok)}
    .recv{border-left-color:var(--recv)}
    .pending{border-left-color:var(--pend)} /* NOVO: PENDENTES: cinza claro */

    .title{font-weight:800;margin-bottom:6px;line-height:1.25}
    .meta-text{font-size:13px;color:var(--muted);display:grid;gap:2px}
    .chip{display:inline-block;background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;margin-left:6px}
    .code{display:inline-block;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;background:#eef2ff;color:var(--mono);border:1px solid #c7d2fe;padding:2px 6px;border-radius:6px;margin-right:6px}

    .progress{margin-top:8px;background:#e5e7eb;border:1px solid #d1d5db;border-radius:999px;height:10px;overflow:hidden}
    .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#22c55e);transition:width .35s ease}
    .progress-label{margin-top:4px;font-size:12px;color:#334155;display:flex;justify-content:space-between}

    /* Selo inspirador (tarefas finalizadas) */
    .seal{position:absolute;top:-8px;left:-8px;z-index:5;padding:6px 10px;border-radius:999px;color:#fff;font-size:11px;font-weight:900;letter-spacing:.3px;box-shadow:0 6px 18px rgba(2,6,23,.2);transform:rotate(-7deg)}
    .seal svg{width:14px;height:14px;vertical-align:-2px;margin-right:6px}
    .seal.ontime{background:linear-gradient(135deg,#2563eb,#38bdf8)}
    .seal.early{background:linear-gradient(135deg,#16a34a,#22c55e)}
    .seal.late{background:linear-gradient(135deg,#7c3aed,#a78bfa)} /* tom positivo mesmo no atraso: foco no feito */

    /* Rodapé: filtros + relógio e texto */
    footer{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);color:#334155;font-size:12px}
    .foot-wrap{max-width:1100px;margin:0 auto;padding:6px 10px}
    .foot-note{display:flex;align-items:center;gap:8px;line-height:1.35;margin-bottom:6px}
    .foot-note .badge{font-variant-numeric:tabular-nums;background:#e2e8f0;border-radius:8px;padding:2px 8px}
    .filters{display:flex;gap:6px;overflow:auto;padding:6px 0}
    .filters::-webkit-scrollbar{height:6px}
    .filters::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
    .fbtn{appearance:none;border:1px dashed #cbd5e1;background:#f8fafc;color:#334155;padding:6px 10px;border-radius:999px;font-size:11px;font-weight:700;opacity:.9;cursor:pointer;white-space:nowrap}
    .fbtn[aria-pressed="true"]{background:#eef2ff;border-style:solid;border-color:#93c5fd}
    .fcnt{font-variant-numeric:tabular-nums;background:#e2e8f0;padding:2px 6px;border-radius:8px;margin-left:6px}

    .share-btn{position:absolute;top:8px;right:8px;width:28px;height:28px;border:none;border-radius:999px;background:var(--wa);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:.92;box-shadow:0 2px 6px rgba(2,6,23,.15)}
    .share-btn:hover{opacity:1}
    .share-btn:active{transform:scale(.96)}
    .share-btn:focus-visible{outline:2px solid var(--ring);outline-offset:2px}
    .wa-ico{width:16px;height:16px;display:block}

    .modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:200}
    .modal.open{display:flex}
    .modal-card{width:100%;max-width:520px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 12px 30px rgba(2,6,23,.25);padding:14px}
    .modal-title{margin:0 0 8px;font-size:16px;font-weight:800}
    .modal-sub{margin:0 0 8px;font-size:12px;color:var(--muted)}
    .modal-textarea{width:100%;min-height:96px;border:1px solid var(--border);border-radius:10px;padding:10px;font-size:14px;resize:vertical}
    .modal-actions{margin-top:12px;display:flex;gap:8px;justify-content:flex-end}
    .btn{appearance:none;border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.cancel{background:#e5e7eb}
    .btn.send{background:var(--wa);color:#fff;display:inline-flex;align-items:center;gap:8px}
    .btn.send .wa-ico{filter:brightness(0) invert(1)}

    .hidden{display:none !important}

    @media (prefers-color-scheme:dark){
      :root{--bg:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--card:#0f172a;--border:#1f2937}
      .btn.cancel{background:#1f2937;color:#e5e7eb}
      .share-btn{background:var(--wa-dark)}
      .fbtn{border-color:#334155;background:#0f172a;color:#e5e7eb}
      .fcnt{background:#1f2937}
      .fbtn[aria-pressed="true"]{background:#0b1220;border-color:#2563eb}
      .foot-note .badge{background:#1f2937}
    }
  </style>
</head>
<body>
  <header id="hdr" role="banner" aria-label="Cabeçalho do Kanban">
    <div class="head-top">
      <div class="brand">
        <img class="logo" src="assets/logo.jpg" alt="System Engenharia" />
        <div>
          <h1>Atlântico Golf — Quadro Kanban</h1>
        </div>
      </div>
      <div class="meta" aria-live="polite">
        <div class="stamp" id="stamp">--/--/---- --:--</div>
      </div>
    </div>
  </header>

  <main class="board" id="board" role="list" aria-label="Colunas do Kanban"></main>

  <footer id="ftr">
    <div class="foot-wrap">
      <div class="foot-note" id="footNote" role="status" aria-live="polite">
        <strong>Atualização da Engenharia</strong>
        <span class="badge" id="clock">--:--:--</span>
      </div>
      <nav class="filters" role="toolbar" aria-label="Filtros de status">
        <button type="button" class="fbtn" data-val="all" aria-pressed="true">Todos <span class="fcnt" data-cnt="all">0</span></button>
        <button type="button" class="fbtn" data-val="exec" aria-pressed="false">Em execução <span class="fcnt" data-cnt="exec">0</span></button>
        <button type="button" class="fbtn" data-val="block" aria-pressed="false">Bloqueadas <span class="fcnt" data-cnt="block">0</span></button>
        <button type="button" class="fbtn" data-val="overdue" aria-pressed="false">Atrasadas <span class="fcnt" data-cnt="overdue">0</span></button>
        <button type="button" class="fbtn" data-val="pending" aria-pressed="false">Pendentes <span class="fcnt" data-cnt="pending">0</span></button>
        <button type="button" class="fbtn" data-val="done" aria-pressed="false">Finalizadas <span class="fcnt" data-cnt="done">0</span></button>
        <button type="button" class="fbtn" data-val="clear" aria-pressed="false">Limpar</button>
      </nav>
    </div>
  </footer>

  <!-- Modal de nota antes de compartilhar -->
  <div class="modal" id="shareModal" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
    <div class="modal-card">
      <h3 class="modal-title" id="shareTitle">Enviar no WhatsApp</h3>
      <p class="modal-sub">Escreva o comentário que vai junto. O texto do card é preenchido automaticamente com data e hora.</p>
      <textarea id="shareNote" class="modal-textarea" placeholder="Ex.: Aguardando liberação do acesso no subsolo."></textarea>
      <div class="modal-actions">
        <button class="btn cancel" id="shareCancel">Cancelar</button>
        <button class="btn send" id="shareSend">
          <svg class="wa-ico" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 3C9.373 3 4 8.373 4 15c0 2.11.548 4.09 1.504 5.82L4 29l8.332-1.46C14.016 28.48 15.975 29 18 29c6.627 0 12-5.373 12-12S22.627 3 16 3zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10c-1.822 0-3.53-.5-4.99-1.365l-.356-.213-4.7.824.85-4.572-.232-.375C5.557 18.188 5 16.65 5 15 5 9.477 10.477 5 16 5zm-4.04 4.75c-.202 0-.52.074-.792.37-.272.296-1.04 1.015-1.04 2.469s1.06 2.864 1.22 3.079c.162.215 2.09 3.183 5.073 4.454.715.305 1.273.484 1.71.617.72.22 1.372.186 1.89.11.58-.083 1.78-.73 2.04-1.43.26-.7.26-1.316.19-1.437-.07-.12-.277-.196-.575-.337-.298-.14-1.75-.87-2.02-.97-.27-.1-.47-.144-.668.14-.198.283-.786.942-.958 1.128-.17.186-.334.202-.624.067-.29-.135-1.24-.46-2.37-1.485-.88-.798-1.49-1.783-1.66-2.082-.17-.3-.02-.466.124-.61.122-.12.3-.33.447-.5.147-.17.2-.294.308-.49.108-.196.53-.368-.022-.512-.075-.143-.683-1.64-.94-2.236-.256-.595-.503-.52-.682-.52z" fill="#fff"/></svg>
          Enviar
        </button>
      </div>
    </div>
  </div>

  <script>
  (()=>{
    'use strict';

    /* =============================================================
     *  BLOCO DE EDIÇÃO RÁPIDA (para uso com IA) — DADOS + REGRAS
   (inicie o copie e cole aqui)
 * ============================================================= */

const RULES = {
  autoFinalizeAtPct: 100,
  assumeDueAsDoneDateWhenMissing: true,
  sortDoneLast: true,
  finalizeOnPaste: true,
  showSiteNotice: false,
  siteNoticeId: null
};

// Aviso de mudança REMOVIDO

const DATA = {
  encarregados:[
    {nome:'Severo (Hidráulica)', tarefas:[
      {codigo:'T-0313', titulo:'Rede hidráulica de entrada de água — conclusão', prazo_esperado:'19/09/2025', status:'exec', pct:95, obs:'Limpeza Patrimar.'},
      {codigo:'T-0314', titulo:'Troca do suporte da rede Ø110 mm: perfilado → cantoneira (recalque de pluviais e esgoto)', prazo_esperado:'19/09/2025', status:'done', pct:100},
      {codigo:'T-0322', titulo:'Retrabalho de 7 caixas de rede externa, reposicionamento de tubulações e acabamento — aditivo', prazo_esperado:'26/09/2025', status:'done', pct:100},
      {codigo:'T-0323', titulo:'Montagem de conjuntos de bombas em 3 poços', prazo_esperado:'26/09/2025', status:'done', pct:100},
      {codigo:'T-0330', titulo:'Águas pluviais — poços 07, 08, 11 e 12', prazo_esperado:'03/10/2025', status:'exec', pct:50, obs:'Aguardando adaptadores de 60×2" marrom e joelhos 45°.'},
      {codigo:'T-0331', titulo:'Águas servidas — poços 07 e 18', prazo_esperado:'03/10/2025', status:'exec', pct:75, obs:'Pendente conexões.'},
      // Novo serviço (conclusão em 17/10)
      {codigo:'T-0348', titulo:'Fechamento de ralos no subsolo (40 ralos)', prazo_esperado:'', status:'done', pct:100, data_conclusao:'17/10/2025', obs:'Aguardando tubos de 150mm (ajuste pós-conclusão).'}
    ]},
    {nome:'Airton (Hidráulica)', tarefas:[
      {codigo:'T-0305', titulo:'Entrega de apartamentos para a Qualidade — Blocos 2 e 3 — 1º ao 4º pavimentos', prazo_esperado:'19/09/2025', status:'done', pct:100, data_conclusao:'19/09/2025'},
      {codigo:'T-0306', titulo:'Instalação da redutora de pressão — 8º pavimento — Bloco 3', prazo_esperado:'19/09/2025', status:'exec', pct:100},
      {codigo:'T-0324', titulo:'Entrega de apartamentos — 4º ao 6º pavimentos dos Blocos 2 e 3', prazo_esperado:'26/09/2025', status:'done', pct:100, obs:'Atualizado pela Engenharia em 25/09: avanço 95% (concluído 100%).'},
      {codigo:'T-0325', titulo:'Execução da redutora de pressão — 12º pavimento do Bloco 3', prazo_esperado:'26/09/2025', status:'done', pct:100},
      {codigo:'T-0341', titulo:'Entrega de apartamentos — 7º ao 10º pavimentos dos Blocos 2 e 3', prazo_esperado:'03/10/2025', status:'exec', pct:20, obs:'Prazo Patrimar até 25/10.'},
      // Novos serviços (conclusão em 17/10)
      {codigo:'T-0344', titulo:'Redutoras de pressão — Bloco 2 (ajustes com a lixeira)', prazo_esperado:'', status:'done', pct:100, data_conclusao:'17/10/2025', obs:'Verificar com a Patrimar.'},
      {codigo:'T-0345', titulo:'Instalação de tês de fachada — Bloco 2', prazo_esperado:'', status:'done', pct:100, data_conclusao:'17/10/2025', obs:'Dependia do balancim.'},
      {codigo:'T-0346', titulo:'Instalação de bombas de pressurização — Bloco 3', prazo_esperado:'', status:'done', pct:100, data_conclusao:'17/10/2025', obs:'Adaptador recebido.'},
      {codigo:'T-0347', titulo:'Instalação de bombas de pressurização — Bloco 2', prazo_esperado:'', status:'done', pct:100, data_conclusao:'17/10/2025'}
    ]},
    {nome:'Thiago (Elétrica)', tarefas:[
      {codigo:'T-0315', titulo:'Tratamento de todas as eletrocalhas', prazo_esperado:'19/09/2025', status:'exec', pct:95},
      {codigo:'T-0317', titulo:'Instalação de 5 quadros de bombas', prazo_esperado:'19/09/2025', status:'done', pct:100, data_conclusao:'19/09/2025'},
      {codigo:'T-0316', titulo:'Instalação de luminárias — trecho central do subsolo (±50 unidades em zonas apagadas)', prazo_esperado:'19/09/2025', status:'exec', pct:100},
      {codigo:'T-0321', titulo:"Instalação de CSMD's dos blocos 1, 2 e 3", prazo_esperado:'26/09/2025', status:'exec', pct:70, obs:'Aguardando chegada do restante dos painéis da ELETROASA.'},
      {codigo:'T-0338', titulo:'Infra no subsolo para automático de boia das torres', prazo_esperado:'26/09/2025', status:'exec', pct:50, obs:'Aguardando chegada de luvas de PVC 1 1/2".'},
      {codigo:'T-0339', titulo:'Montagem de eletrocalha 200×150 para comandos — trecho central do subsolo', prazo_esperado:'26/09/2025', status:'exec', pct:50, obs:'Janela: 22/09 a 26/09.'},
      {codigo:'T-0340', titulo:'Montagem de perfilado 38×38 para iluminação do espelho d’água 2', prazo_esperado:'26/09/2025', status:'done', pct:100, data_conclusao:'25/09/2025'},
      {codigo:'T-0337', titulo:'Instalação de 100 luminárias — trecho entre a casa de bombas e o espelho d’água', prazo_esperado:'03/10/2025', status:'exec', pct:15, obs:'Janela: 29/09 a 03/10.'},
      {codigo:'T-0342', titulo:'Instalação de tomadas nas 4 edículas e academia', prazo_esperado:'03/10/2025', status:'done', pct:100},
      // Novo serviço (conclusão em 17/10)
      {codigo:'T-0350', titulo:'Instalação de bases de postes', prazo_esperado:'', status:'done', pct:100, data_conclusao:'17/10/2025'}
    ]},
    {nome:'Marcelo (Elétrica)', tarefas:[
      {codigo:'T-0318', titulo:'Entrega de apartamentos — 4º ao 6º', prazo_esperado:'19/09/2025', status:'done', pct:100},
      {codigo:'T-0319', titulo:'Fechamento de QDLs dos apartamentos — 19º e 20º (duas torres)', prazo_esperado:'19/09/2025', status:'block', pct:40, obs:"Aguardando materiais (componentes para QDL's)"},
      {codigo:'T-0320', titulo:'SPDA das duas torres (executar áreas liberadas)', prazo_esperado:'19/09/2025', status:'exec', pct:30},
      {codigo:'T-0326', titulo:'Instalação das tampas dos barramentos blindados verticais — 3 torres', prazo_esperado:'26/09/2025', status:'exec', pct:70},
      {codigo:'T-0327', titulo:'Ensaios/funcionais dos barramentos blindados', prazo_esperado:'26/09/2025', status:'exec', pct:33},
      {codigo:'T-0328', titulo:'Instalação dos cofres pendentes', prazo_esperado:'26/09/2025', status:'exec', pct:70},
      {codigo:'T-0332', titulo:'Lançamento de cabos — Bomba de recalque Bloco 1', prazo_esperado:'03/10/2025', status:'done', pct:100, data_conclusao:'26/09/2025'},
      {codigo:'T-0333', titulo:'Lançamento de cabos — Bomba de recalque Bloco 2', prazo_esperado:'03/10/2025', status:'done', pct:100, data_conclusao:'25/09/2025'},
      {codigo:'T-0334', titulo:'Lançamento de cabos — Bomba de recalque Bloco 3', prazo_esperado:'03/10/2025', status:'done', pct:100, data_conclusao:'24/09/2025'},
      {codigo:'T-0335', titulo:'Passagem de fiação para os espelhos d’água 2 e 3', prazo_esperado:'03/10/2025', status:'done', pct:100, data_conclusao:'26/09/2025'},
      {codigo:'T-0336', titulo:'Passagem/lançamento de cabos — poços de águas servidas 03A e 03B', prazo_esperado:'03/10/2025', status:'done', pct:100, data_conclusao:'26/09/2025'},
      {codigo:'T-0343', titulo:'Lançamento de cabos alimentadores — QT-SS-BL1, QT-Guarita, QT-Gourmet 1, QT-Gourmet 2, QT-Águas Servidas 03A', prazo_esperado:'03/10/2025', status:'exec', pct:40},
      // Novo serviço (conclusão em 17/10)
      {codigo:'T-0349', titulo:'Lançamento de cabos alimentadores — QF-A-PLUVIAIS 14, QF-A-SERVIDAS 20, PF-PISCINA BL3, PF-PISCINA 5', prazo_esperado:'', status:'done', pct:100, data_conclusao:'17/10/2025'}
    ]}
  ],

  suprimentos:{
    compradores:['Brígida Souza','Suellen Mello','Lucas Fernandes'],
    pendencias_teams:{'Brígida Souza':0,'Suellen Mello':0,'Lucas Fernandes':0},

    requisicoes:[
      {codigo:'RQ-11305', numero:'RQ-11305', responsavel:'Brígida Souza', contrato:'Atlântico', material:'Condulete', aplicacao:'-', data:'', prazo:'', status:'Em cotação', obs:'Sem atualização'},
      {codigo:'RQ-11379', numero:'RQ-11379', responsavel:'Brígida Souza', contrato:'Atlântico', material:'Aditivo', aplicacao:'-', data:'', prazo:'', status:'Em cotação', obs:'Sem atualização'},
      {codigo:'RQ-11086', numero:'RQ-11086', responsavel:'Suellen Mello', contrato:'Atlântico', material:'Repastilhamento', aplicacao:'-', data:'', prazo:'', status:'Em aprovação', obs:'Almoxarife informar suprimentos para repastilhamento'},
      {codigo:'RQ-11291', numero:'RQ-11291', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'PIAL PLUS+', aplicacao:'Áreas comuns / subsolo / escadas / coberturas / extravios', data:'', prazo:'', status:'Em aprovação', obs:'Aguardando aprovação do cliente'},
      {codigo:'RQ-11294', numero:'RQ-11294', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'Arandelas', aplicacao:'Escadas e áreas técnicas', data:'', prazo:'', status:'Em aprovação', obs:'Aguardando aprovação do cliente'},
      {codigo:'RQ-11309', numero:'RQ-11309', responsavel:'Suellen Mello', contrato:'Atlântico', material:'Parafuso', aplicacao:'-', data:'26/09/2025', prazo:'', status:'Em andamento', obs:'Fornecedor: PARAFUSOPAR. Não chegou'}
    ],

    ocs:[
      {codigo:'OC-587', numero:'OC-587', emissao:'', fornecedor:'WALSYWA Comércio de Produtos Metalúrgicos Ltda', status:'EMITIDA', previsao:'', comprador:'Suellen Mello', recebido:'16/09/2025 (parcial)', origem_rq:'RQ-11295', material:'Material de fixação', aplicacao:'-', obs_comprador:'Parcial'},
      {codigo:'OC-597', numero:'OC-597', emissao:'', fornecedor:'KG Instalações e Com. Elétrico', status:'EMITIDA', previsao:'', comprador:'Suellen Mello', recebido:'18/09/2025 (parcial)', origem_rq:'RQ-11181', material:'PVC', aplicacao:'Ralos/fechamentos', obs_comprador:'Parcial'},
      {codigo:'OC-009', numero:'OC-009', emissao:'', fornecedor:'ELETROASA — Eletrometalúrgica ASA Eireli', status:'EMITIDA', previsao:'03/10/2025', comprador:'Lucas Fernandes', recebido:'09/09/2025 (parcial)', origem_rq:'RQ-10623', material:'Quadros de entrada de energia', aplicacao:'Entrada de energia', obs_comprador:'Entrega parcial 09/09; restante 03/10'},
      {codigo:'OC-591', numero:'OC-591', emissao:'', fornecedor:'Westaflex Tubos Flexíveis Ltda', status:'EMITIDA', previsao:'', comprador:'Lucas Fernandes', recebido:'', origem_rq:'RQ-11282', material:'Tê de fachada', aplicacao:'Fachada', obs_comprador:'Não chegou'},
      {codigo:'OC-595', numero:'OC-595', emissao:'', fornecedor:'KG Instalações e Comércio Elétrico Ltda', status:'EMITIDA', previsao:'', comprador:'Lucas Fernandes', recebido:'19/09/2025 (parcial)', origem_rq:'RQ-11238', material:'Ralo + PVC', aplicacao:'Distribuição hidráulico térreo', obs_comprador:'Entrega parcial'},
      {codigo:'OC-590', numero:'OC-590', emissao:'', fornecedor:'Lukma', status:'EMITIDA', previsao:'17/09/2025', comprador:'Lucas Fernandes', recebido:'', origem_rq:'RQ-11314', material:'Fitas isolantes', aplicacao:'Elétrica força e distribuição'},

      // ======== ENTREGUES (ao final) ========
      {codigo:'OC-585', numero:'OC-585', emissao:'', fornecedor:'Lukma', status:'RECEBIDO', previsao:'', comprador:'Lucas Fernandes', recebido:'16/09/2025', origem_rq:'RQ-11237', material:'Fita isolante', aplicacao:'Elétrica força e distribuição'},
      {codigo:'OC-593', numero:'OC-593', emissao:'', fornecedor:'Mosal Artefatos de Alumínio Ltda - ME', status:'RECEBIDO', previsao:'', comprador:'Lucas Fernandes', recebido:'12/09/2025', origem_rq:'RQ-11333', material:'Tê de fachada', aplicacao:'Fachada', obs_comprador:'Chegou'}
    ]
  }
};

/* =============================================================
 *  (terminei o copie e cole aqui)
     * ============================================================= */

    const DAY=86400000, HOUR=36e5;
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const el = (tag, cls, text) => { const e=document.createElement(tag); if(cls) e.className=cls; if(text!=null) e.textContent=text; return e };
    const pad = n => String(n).padStart(2,'0');
    const parseBRDate = s => { if(!s) return null; const a=s.split('/'); if(a.length!==3) return null; const [d,m,y]=a.map(Number); const dt=new Date(y,(m||1)-1,d||1,12,0,0); return isNaN(dt)?null:dt };

    const STATUS_LABEL = { exec:'Em execução', block:'Bloqueada', done:'Finalizada', FINALIZADA:'Finalizada', pending:'Pendente' };

    const WHATSVG = '<svg class="wa-ico" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 3C9.373 3 4 8.373 4 15c0 2.11.548 4.09 1.504 5.82L4 29l8.332-1.46C14.016 28.48 15.975 29 18 29c6.627 0 12-5.373 12-12S22.627 3 16 3zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10c-1.822 0-3.53-.5-4.99-1.365l-.356-.213-4.7.824.85-4.572-.232-.375C5.557 18.188 5 16.65 5 15 5 9.477 10.477 5 16 5zm-4.04 4.75c-.202 0-.52.074-.792.37-.272.296-1.04 1.015-1.04 2.469s1.06 2.864 1.22 3.079c.162.215 2.09 3.183 5.073 4.454.715.305 1.273.484 1.71.617.72.22 1.372.186 1.89.11.58-.083 1.78-.73 2.04-1.43.26-.7.26-1.316.19-1.437-.07-.12-.277-.196-.575-.337-.298-.14-1.75-.87-2.02-.97-.27-.1-.47-.144-.668.14-.198.283-.786.942-.958 1.128-.17.186-.334.202-.624.067-.29-.135-1.24-.46-2.37-1.485-.88-.798-1.49-1.783-1.66-2.082-.17-.3-.02-.466.124-.61.122-.12.3-.33.447-.5.147-.17.2-.294.308-.49.108-.196.53-.368-.022-.512-.075-.143-.683-1.64-.94-2.236-.256-.595-.503-.52-.682-.52z" fill="#fff"/></svg>';

    let NOW = new Date();
    const dLabel = s => { const d=parseBRDate(s); if(!d) return ''; const delta=Math.floor((d - NOW)/DAY); return delta===0? 'D-0' : (delta>0? 'D-'+delta : 'D+'+Math.abs(delta)); };
    const isPastDue = s => { const d=parseBRDate(s); return !!(d && (NOW - d) > 0); };
    const urgencyByDate = (dateStr,status)=>{
      if(status==='done'||status==='FINALIZADA') return 'done';
      if(isPastDue(dateStr)) return 'overdue';
      if(status==='recebido') return 'recv';
      if(status==='block') return 'block';
      if(status==='exec') return 'exec';
      const d=parseBRDate(dateStr); if(!d) return 'ok';
      const h=(d-NOW)/HOUR; return (h<=48)?'soon':'ok';
    };

    const compareByPrazo = (a,b)=>{
      const u = ds => { const d=parseBRDate(ds); if(!d) return 3; const h=(d-NOW)/HOUR; return (h<=0)?0:(h<=48?1:2) };
      const aDate=a.prazo_esperado||a.prazo||a.previsao||a.data||'';
      const bDate=b.prazo_esperado||b.prazo||b.previsao||b.data||'';
      const ua=u(aDate), ub=u(bDate);
      if(ua!==ub) return ua-ub;
      const da=parseBRDate(aDate), db=parseBRDate(bDate);
      if(da&&db) return da-db; if(da&&!db) return -1; if(!da&&db) return 1; return 0;
    };

    const compareOC = (a,b)=>{
      const ar=!!a.recebido, br=!!b.recebido; if(ar!==br) return (br - ar);
      if(ar&&br){ const da=parseBRDate(a.recebido), db=parseBRDate(b.recebido); if(da&&db) return db-da; if(da&&!db) return -1; if(!da&&db) return 1; }
      return compareByPrazo({previsao:a.previsao,status:a.status},{previsao:b.previsao,status:b.status});
    };

    const diffDias = (plannedStr, realStr) => {
      const p = parseBRDate(plannedStr), r = parseBRDate(realStr);
      if(!p || !r) return 0;
      return Math.round((r - p)/DAY);
    };
    const fmtDiffPlain = n => {
      const abs = Math.abs(n);
      const plural = abs===1? 'dia' : 'dias';
      if(n===0) return `Diferença: 0 dias`;
      if(n<0)  return `Diferença: ${abs} ${plural} (adiantado)`;
      return `Diferença: ${n} ${plural} (em atraso)`;
    };

    function formatStatus(status, dueStr){
      if(status in STATUS_LABEL) return STATUS_LABEL[status];
      return isPastDue(dueStr)?'Atrasada':'Pendente';
    }
    function nowStamp(){
      const d = new Date();
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function buildTaskMessage(t, encarregado, note){
      const EMOJI_BY_STATUS = { exec:'🛠️', block:'⛔', done:'✅', FINALIZADA:'✅', overdue:'⏰', pending:'🟡', recv:'📦' };
      const due = t.prazo_esperado||t.prazo||'-';
      const pct = Math.max(0, Math.min(100, Number(t.pct||0)));
      const urg = urgencyByDate(due, t.status);
      const status = formatStatus(t.status, due);
      const eStatus = EMOJI_BY_STATUS[t.status] || (urg==='overdue' ? '⏰' : (status==='Pendente' ? '🟡' : '📌'));
      const obsText = (t.obs||'');
      const eObs = obsText.match(/material|OC|fornecedor|chegou|entrega/i) ? '📦' :
                   obsText.match(/aguard|obstru|acesso|libera/i) ? '🚧' :
                   obsText.match(/janela|prazo|programa/i) ? '🗓️' : '📝';
      const dLbl = due ? dLabel(due) : '';
      const isFinal = (t.status==='done'||t.status==='FINALIZADA') && !!t.data_conclusao;
      const dif = isFinal ? diffDias(due, t.data_conclusao) : 0;
      const eDif = isFinal ? (dif<0 ? '🟢' : (dif>0 ? '🔴' : '⚖️')) : '';
      const code = t.codigo ? `\`#${t.codigo}\`` : '';
      const header = `${eStatus} *${code} ${t.titulo}*`;
      const lines = [];
      lines.push(`👤 Responsável: ${encarregado}`);
      lines.push(`📈 Status: *${status}* • Avanço: *${pct}%*`);
      lines.push(`📅 Prazo esperado: *${due || '-'}*${dLbl? ` • ${dLbl}`:''}`);
      if(isFinal){
        lines.push(`🏁 Concluído em: *${t.data_conclusao}*`);
        lines.push(`${eDif} ${fmtDiffPlain(dif)}`);
      }
      if(obsText){ lines.push(`${eObs} Obs.: ${obsText}`); }
      const stamp = nowStamp();
      const comment = `💬 *Comentário (${stamp}):* ${note}`;
      return `${header}\n${lines.join('\n')}\n\n${comment}`;
    }
    function openWhatsAppWithText(text){
      const enc = encodeURIComponent(text);
      const isMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
      const deeplink = `whatsapp://send?text=${enc}`;
      const web = `https://wa.me/?text=${enc}`;
      if(isMobile){
        const w = window.open(deeplink, '_blank');
        setTimeout(()=>{ if(!w || w.closed) window.open(web, '_blank'); }, 600);
      } else {
        window.open(web, '_blank');
      }
    }

    const modal = document.querySelector('#shareModal');
    const noteEl = document.querySelector('#shareNote');
    const sendBtn = document.querySelector('#shareSend');
    const cancelBtn = document.querySelector('#shareCancel');
    let shareCtx = null;
    function openModal(ctx){ shareCtx = ctx; noteEl.value=''; modal.classList.add('open'); noteEl.focus(); }
    function closeModal(){ modal.classList.remove('open'); shareCtx=null; }
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
    sendBtn.addEventListener('click', ()=>{
      if(!shareCtx) return;
      const note = noteEl.value.trim();
      if(!note){ noteEl.focus(); noteEl.setCustomValidity('Digite uma nota.'); noteEl.reportValidity(); setTimeout(()=>noteEl.setCustomValidity(''), 800); return; }
      const msg = buildTaskMessage(shareCtx.t, shareCtx.enc, note);
      closeModal();
      openWhatsAppWithText(msg);
    });

    const boardEl = document.querySelector('#board');

    function normalizeStatus(t){
      const pct = Number(t.pct||0);
      if(pct>=RULES.autoFinalizeAtPct){ t.status='done'; return; }
      const s=(t.status||'').toLowerCase();
      if(s==='block') return;
      if(pct>0){ t.status='exec'; }
    }
    function isDone(t){ return t.status==='done' || t.status==='FINALIZADA' || Number(t.pct||0) >= RULES.autoFinalizeAtPct; }

    function ensureConclusionDates(){
      for(const enc of DATA.encarregados){
        for(const t of (enc.tarefas||[])){
          normalizeStatus(t);
          if(isDone(t) && !t.data_conclusao && RULES.assumeDueAsDoneDateWhenMissing){
            t.data_conclusao = t.prazo_esperado || t.prazo || '';
          }
        }
      }
    }

    function sortTasks(a,b){
      if(RULES.sortDoneLast){
        const ad = isDone(a), bd = isDone(b);
        if(ad !== bd) return ad ? 1 : -1;
      }
      return compareByPrazo(a,b);
    }

    function cardHeader(t){
      const header = el('div','');
      header.appendChild(el('span','code','#'+(t.codigo||'')));
      const title = el('span','title'); title.textContent = t.titulo; header.appendChild(title);
      return header;
    }

    function makeSeal(diff){
      const s = document.createElement('div');
      s.className = 'seal';
      let label = 'Concluído';
      let cls = 'late';
      if(diff < 0){ label = 'Adiantado'; cls = 'early'; }
      else if(diff === 0){ label = 'No Prazo'; cls = 'ontime'; }
      s.classList.add(cls);
      s.setAttribute('title', 'Parabéns! Trabalho entregue.');
      s.setAttribute('aria-label', 'Selo de conclusão');
      s.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M12 2l2.39 4.84 5.34.78-3.86 3.76.91 5.31L12 14.77 6.22 16.69l.91-5.31L3.27 7.62l5.34-.78L12 2z"/></svg> <span>${label}</span>`;
      return s;
    }

    // NOVO: lógica de "pendente" (0%) para aplicar tarja cinza
    function isTaskPendingStatus(t, urg, pct){
      const st = (t.status||'').toLowerCase();
      if(pct > 0) return false;
      if(st==='done' || st==='finalizada' || st==='exec' || st==='block') return false;
      if(urg==='overdue') return false;
      return (urg==='ok' || urg==='soon' || !urg);
    }

    function buildTaskCard(t, encarregado){
      const pct = Math.max(0, Math.min(100, Number(t.pct||0)));
      const dueStr = t.prazo_esperado||t.prazo||'';
      const urg = urgencyByDate(dueStr,t.status);
      const card = el('article', `card task-card ${urg}`);
      card.dataset.st = (t.status||'').toLowerCase();
      card.dataset.urg = urg;
      card.dataset.pct = String(pct);

      // aplica classe visual de pendente (tarja cinza claro)
      if(isTaskPendingStatus(t, urg, pct)) card.classList.add('pending');

      const header = cardHeader(t);
      const btn = document.createElement('button');
      btn.className='share-btn'; btn.type='button'; btn.title='Compartilhar no WhatsApp'; btn.setAttribute('aria-label','Compartilhar no WhatsApp');
      btn.innerHTML = WHATSVG;
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); openModal({t, enc: encarregado}); });

      const meta = el('div','meta-text');
      const parts = [];
      let pEsperado = 'Prazo esperado: '+(dueStr||'-');
      if(card.dataset.st!=='done' && card.dataset.st!=='finalizada') pEsperado += ' • '+dLabel(dueStr||'');
      parts.push(pEsperado);

      const isFinal = (t.status==='done'||t.status==='FINALIZADA') && !!t.data_conclusao;
      let dif = 0;
      if(isFinal){
        parts.push('Concluído em: '+t.data_conclusao);
        dif = diffDias(dueStr, t.data_conclusao);
        parts.push(fmtDiffPlain(dif));
      }
      if(t.obs) parts.push('Obs.: '+t.obs);
      meta.innerHTML = parts.map(p=>`<div>${p}</div>`).join('');

      const label = STATUS_LABEL[t.status] || (card.className.includes('overdue')? 'Atrasada' : 'Pendente');
      const chip = el('span','chip',label); meta.appendChild(chip);

      const pWrap = el('div','progress');
      const pBar = el('div','progress-inner'); pBar.style.width = pct+'%'; pWrap.appendChild(pBar);
      const pLabel = el('div','progress-label'); pLabel.appendChild(el('span','', 'Avanço: '+pct+'%'));

      // SELO INSPIRADOR
      if(isFinal){
        const seal = makeSeal(dif);
        card.appendChild(seal);
      }

      card.appendChild(header); card.appendChild(meta); card.appendChild(pWrap); card.appendChild(pLabel); card.appendChild(btn);
      return card;
    }

    function renderEncColumns(){
      ensureConclusionDates();
      const frag = document.createDocumentFragment();
      for(const enc of DATA.encarregados){
        const col = el('section','column'); col.setAttribute('role','region'); col.setAttribute('aria-label',enc.nome);
        col.appendChild(el('h2','',enc.nome));
        const list = el('div','list');
        const tasks = (enc.tarefas||[]).slice().sort(sortTasks);
        for(const t of tasks){
          list.appendChild(buildTaskCard(t, enc.nome));
        }
        col.appendChild(list); frag.appendChild(col);
      }
      boardEl.appendChild(frag);
    }

    function renderSuppliesColumn(){
      const sup = DATA.suprimentos || {}; const rqs=(sup.requisicoes||[]).slice(); const ocs=(sup.ocs||[]).slice();
      rqs.sort((a,b)=>compareByPrazo(a,b)); ocs.sort(compareOC);
      const col = el('section','column'); col.setAttribute('role','region'); col.setAttribute('aria-label','Suprimentos');
      col.appendChild(el('h2','', 'Suprimentos'));
      const list = el('div','list');

      const rqHdr = el('div','title','Requisições em Aberto'); list.appendChild(rqHdr);
      for(const rq of rqs){
        const it = el('article','card '+urgencyByDate(rq.prazo, rq.status));
        const kv1=el('div','meta-text','');
        kv1.innerHTML = [
          `<div><span class="code">#${rq.codigo||rq.numero||''}</span><strong>${rq.numero||rq.codigo||'RQ'}</strong></div>`,
          `<div>Data: ${rq.data||'-'} • Prazo: ${rq.prazo||'-'}</div>`,
          `<div>Resp.: ${rq.responsavel||'-'} • Contrato: ${rq.contrato||'-'} • Material: ${rq.material||'-'}</div>`,
          `<div>Aplicação: ${rq.aplicacao||'-'} • Obs.: ${rq.obs||'-'}</div>`
        ].join('');
        list.appendChild(it); it.appendChild(kv1);
      }

      const ocHdr = el('div','title','Ordens de Compra (OC)'); list.appendChild(ocHdr);
      for(const oc of ocs){
        const cls = oc.recebido? 'recv' : urgencyByDate(oc.previsao, oc.status);
        const it2 = el('article','card '+cls);
        const kv2=el('div','meta-text','');
        kv2.innerHTML = [
          `<div><span class="code">#${oc.codigo||oc.numero||''}</span><strong>${oc.numero||oc.codigo||'OC'}</strong></div>`,
          `<div>Fornecedor: ${oc.fornecedor||'-'} • Comprador: ${oc.comprador||'-'} • Origem: ${oc.origem_rq||'-'}</div>`,
          `<div>Material: ${oc.material||'-'} • Aplicação: ${oc.aplicacao||'-'}</div>`,
          `<div>Emissão: ${oc.emissao||'-'} • Previsão: ${oc.previsao||'-'}</div>`,
          `${oc.recebido?(`<div>Recebido em ${oc.recebido}</div>`):'<div>Pendente</div>'}`
        ].join('');
        if(oc.obs_comprador){ kv2.innerHTML += `<div>Obs. comprador: ${oc.obs_comprador}</div>`; }
        list.appendChild(it2); it2.appendChild(kv2);
      }

      col.appendChild(list); boardEl.appendChild(col);
    }

    function render(){
      NOW = new Date();
      boardEl.innerHTML='';
      renderEncColumns();
      renderSuppliesColumn();
      updateFilterCounts();
      applyFilters();
    }

    const active = new Set(['all']);

    function isPending(card){
      const st = (card.dataset.st||'').toLowerCase();
      const urg = (card.dataset.urg||'').toLowerCase();
      const pct = parseFloat(card.dataset.pct||'0');
      if(pct > 0) return false;
      if(st==='done') return false;
      if(urg==='overdue' || st==='block' || st==='exec') return false;
      return (urg==='ok' || urg==='soon' || !urg);
    }

    function cardMatches(card){
      if(active.has('all') || active.size===0) return true;
      const st = (card.dataset.st||'').toLowerCase();
      const urg = (card.dataset.urg||'').toLowerCase();
      let match = false;
      if(active.has('exec') && st==='exec') match = true;
      if(active.has('block') && st==='block') match = true;
      if(active.has('done') && st==='done') match = true;
      if(active.has('overdue') && urg==='overdue') match = true;
      if(active.has('pending') && isPending(card)) match = true;
      return match;
    }

    function applyFilters(){
      const cards = document.querySelectorAll('.task-card');
      for(const c of cards){ c.classList.toggle('hidden', !cardMatches(c)); }
    }

    function updateFilterCounts(){
      const cards = document.querySelectorAll('.task-card');
      const counters = {all: cards.length, exec:0, block:0, overdue:0, pending:0, done:0};
      for(const c of cards){
        const st=(c.dataset.st||'').toLowerCase();
        const urg=(c.dataset.urg||'').toLowerCase();
        const pct = parseFloat(c.dataset.pct||'0');
        if(st==='exec' && pct < RULES.autoFinalizeAtPct) counters.exec++;
        if(st==='block') counters.block++;
        if(st==='done' || pct >= RULES.autoFinalizeAtPct) counters.done++;
        if(urg==='overdue') counters.overdue++;
        if(isPending(c)) counters.pending++;
      }
      for(const k in counters){ const e = document.querySelector(`[data-cnt="${k}"]`); if(e) e.textContent = counters[k]; }
    }

    function toggleBtn(btn){
      const val = btn.dataset.val;
      const pressed = btn.getAttribute('aria-pressed') === 'true';
      if(val==='clear'){
        $$('.filters .fbtn').forEach(b=>b.setAttribute('aria-pressed','false'));
        active.clear(); active.add('all');
        document.querySelector('.fbtn[data-val="all"]').setAttribute('aria-pressed','true');
      } else if(val==='all'){
        $$('.filters .fbtn').forEach(b=>{ if(b.dataset.val!=='clear') b.setAttribute('aria-pressed','false'); });
        active.clear(); active.add('all');
        btn.setAttribute('aria-pressed','true');
      } else {
        document.querySelector('.fbtn[data-val="all"]').setAttribute('aria-pressed','false');
        active.delete('all');
        btn.setAttribute('aria-pressed', String(!pressed));
        if(pressed){ active.delete(val); } else { active.add(val); }
        if(active.size===0){ active.add('all'); document.querySelector('.fbtn[data-val="all"]').setAttribute('aria-pressed','true'); }
      }
      applyFilters();
    }

    function bindFilters(){ $$('.filters .fbtn').forEach(b=> b.addEventListener('click', ()=> toggleBtn(b))); }

    function setStamp(){ const d=new Date(); const stamp=`${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; document.querySelector('#stamp').textContent=stamp; }
    function tickClock(){ const t=new Date(); document.querySelector('#clock').textContent = `${pad(t.getHours())}:${pad(t.getMinutes())}:${pad(t.getSeconds())}` }

    function runTests(){
      try{
        console.group('%cKanban Smoke Tests','color:#0ea5e9;font-weight:bold');
        console.assert(parseBRDate('19/09/2025') instanceof Date, 'parseBRDate deve retornar Date');
        console.assert(parseBRDate('')===null, 'parseBRDate vazio deve retornar null');
        console.assert(diffDias('01/01/2020','03/01/2020')===2, 'diffDias básico');
        const msg = buildTaskMessage({codigo:'T-000', titulo:'Teste', prazo_esperado:'10/10/2025', status:'exec', pct:50, obs:'Aguardando material'}, 'Dev', 'Ok');
        console.assert(typeof msg==='string' && msg.includes('Comentário') && msg.includes('\n'), 'Mensagem WA formatada');
        console.groupEnd();
      }catch(e){
        console.error('Falha nos testes:', e);
      }
    }

    window.KANBAN_EXPORT = {
      getData: ()=> JSON.parse(JSON.stringify(DATA)),
      replaceData: (next)=>{ Object.assign(DATA, next||{}); render(); },
      addTask: (encName, task)=>{ const enc = (DATA.encarregados||[]).find(e=>e.nome===encName); if(!enc) return false; enc.tarefas.push(task); render(); return true; }
    };

    document.addEventListener('DOMContentLoaded', ()=>{
      render();
      bindFilters();
      setStamp();
      tickClock();
      setInterval(tickClock, 1000);
      runTests();
    });
  })();
  </script>
</body>
</html>
