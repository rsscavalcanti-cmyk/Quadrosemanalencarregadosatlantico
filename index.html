<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Atlântico Golf — Kanban (WhatsApp Share + Suprimentos)</title>
  <meta name="description" content="Kanban mobile. Botão WhatsApp em cada card (nota obrigatória) e coluna de Suprimentos de volta." />
  <meta name="theme-color" content="#0b2a4a" />
  <style>
    :root{ --bg:#f6f8fc; --text:#0f172a; --muted:#475569; --brand:#0e3a6d; --brand2:#0b2a4a;
      --card:#ffffff; --border:#d6e0ea; --head:#f1f5f9; --ring:#38bdf8;
      --ok:#16a34a; --warn:#ca8a04; --late:#b91c1c; --block:#9333ea; --exec:#0ea5e9; --recv:#15803d;
      --chip:#e2e8f0; --mono:#111827; --wa:#25D366; --wa-dark:#1EA955;
      --header-h:108px; --footer-h:52px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text)}

    header{position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding:12px 16px;background:linear-gradient(90deg,var(--brand2),var(--brand));color:#fff;box-shadow:0 4px 18px rgba(2,6,23,.18)}
    .brand{display:flex;align-items:center;gap:12px;min-width:240px}
    .logo{height:42px;width:auto;display:block;object-fit:contain}
    h1{margin:0;font-size:20px}
    .subtitle{margin-top:2px;font-size:12px;opacity:.9}
    .meta{display:flex;flex-direction:column;gap:4px;text-align:right}
    .stamp{font-size:12px;font-weight:700}
    .clock{font-variant-numeric:tabular-nums;font-size:12px;opacity:.95}

    .board{height:calc(100vh - var(--header-h) - var(--footer-h));display:flex;gap:12px;padding:12px 12px 16px;overflow-x:auto;overflow-y:hidden;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
    .column{background:var(--card);border:1px solid var(--border);border-radius:14px;min-width:300px;max-width:480px;flex:1;display:flex;flex-direction:column;height:100%;overflow:hidden;scroll-snap-align:start;contain:layout paint;}
    .column h2{position:sticky;top:0;z-index:10;margin:0;padding:10px 12px;background:var(--head);font-size:16px;font-weight:800;border-bottom:1px solid var(--border);text-align:center}
    .list{flex:1;overflow:auto;padding:10px}

    .task,.item{background:#fff;margin:8px 0;border:1px solid var(--border);border-left:10px solid var(--border);border-radius:12px;padding:12px 12px 10px;box-shadow:0 3px 10px rgba(2,6,23,.06);position:relative}
    .task.overdue,.item.overdue{border-left-color:var(--late)}
    .task.block,.item.block{border-left-color:var(--block)}
    .task.exec,.item.exec{border-left-color:var(--exec)}
    .task.done,.item.done{border-left-color:var(--ok)}
    .item.soon{border-left-color:var(--warn)}
    .item.ok{border-left-color:var(--ok)}
    .item.recv{border-left-color:var(--recv)}

    .title{font-weight:800;margin-bottom:6px;line-height:1.25}
    .meta-text{font-size:13px;color:var(--muted);display:grid;gap:2px}
    .chip{display:inline-block;background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;margin-left:6px}
    .code{display:inline-block;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;background:#eef2ff;color:var(--mono);border:1px solid #c7d2fe;padding:2px 6px;border-radius:6px;margin-right:6px}

    .progress{margin-top:8px;background:#e5e7eb;border:1px solid #d1d5db;border-radius:999px;height:10px;overflow:hidden}
    .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#22c55e);transition:width .35s ease}
    .progress-label{margin-top:4px;font-size:12px;color:#334155;display:flex;justify-content:space-between}

    .row{display:flex;justify-content:space-between;gap:8px;font-size:14px}
    .kv{font-size:12px;color:var(--muted)}

    footer{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);color:#334155;font-size:12px;display:flex;justify-content:center;align-items:center;min-height:var(--footer-h);padding:6px 10px;text-align:center}
    .foot-note{max-width:1100px;line-height:1.35}

    .share-btn{position:absolute;top:8px;right:8px;width:28px;height:28px;border:none;border-radius:999px;background:var(--wa);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:.92;box-shadow:0 2px 6px rgba(2,6,23,.15)}
    .share-btn:hover{opacity:1}
    .share-btn:active{transform:scale(.96)}
    .share-btn:focus-visible{outline:2px solid var(--ring);outline-offset:2px}
    .wa-ico{width:16px;height:16px;display:block}

    .modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:200}
    .modal.open{display:flex}
    .modal-card{width:100%;max-width:520px;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 30px rgba(2,6,23,.25);padding:14px}
    .modal-title{margin:0 0 8px;font-size:16px;font-weight:800}
    .modal-sub{margin:0 0 8px;font-size:12px;color:var(--muted)}
    .modal-textarea{width:100%;min-height:96px;border:1px solid var(--border);border-radius:10px;padding:10px;font-size:14px;resize:vertical}
    .modal-actions{margin-top:12px;display:flex;gap:8px;justify-content:flex-end}
    .btn{appearance:none;border:none;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.cancel{background:#e5e7eb}
    .btn.send{background:var(--wa);color:#fff;display:inline-flex;align-items:center;gap:8px}
    .btn.send .wa-ico{filter:brightness(0) invert(1)}

    @media (prefers-color-scheme:dark){
      :root{--bg:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--card:#0f172a;--border:#1f2937}
      .btn.cancel{background:#1f2937;color:#e5e7eb}
      .share-btn{background:var(--wa-dark)}
    }
  </style>
</head>
<body>
  <header id="hdr" role="banner" aria-label="Cabeçalho do Kanban">
    <div class="brand">
      <!-- VOLTAR COM O LOGO: substitua o src abaixo pelo endereço exato da sua imagem -->
      <img class="logo" src="INSIRA_AQUI_O_ENDERECO_DO_LOGO" alt="Logo" />
      <div>
        <h1>Atlântico Golf — Quadro Kanban</h1>
        <!-- SUBTÍTULO ENXUTO: removido o trecho irrelevante -->
        <div class="subtitle">Compartilhar o card no WhatsApp.</div>
      </div>
    </div>
    <div class="meta" aria-live="polite">
      <div class="stamp" id="stamp">--/--/---- --:--</div>
      <div class="clock" id="clock" aria-label="Relógio">--:--:--</div>
    </div>
  </header>

  <main class="board" id="board" role="list" aria-label="Colunas do Kanban"></main>

  <footer id="ftr">
    <div class="foot-note" id="footNote">
      <strong>Atualização:</strong> o botão <em>Compartilhar no WhatsApp</em> foi incorporado para agilizar a comunicação das tarefas.
      Para manter a organização, <strong>centralize as mensagens no grupo “Atlântico Interno”</strong>. Obrigado!
    </div>
  </footer>

  <!-- Modal de nota antes de compartilhar -->
  <div class="modal" id="shareModal" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
    <div class="modal-card">
      <h3 class="modal-title" id="shareTitle">Enviar no WhatsApp</h3>
      <p class="modal-sub">Escreva o comentário que vai junto. O texto do card é preenchido automaticamente com data e hora.</p>
      <textarea id="shareNote" class="modal-textarea" placeholder="Ex.: Aguardando liberação do acesso no subsolo."></textarea>
      <div class="modal-actions">
        <button class="btn cancel" id="shareCancel">Cancelar</button>
        <button class="btn send" id="shareSend">
          <svg class="wa-ico" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 3C9.373 3 4 8.373 4 15c0 2.11.548 4.09 1.504 5.82L4 29l8.332-1.46C14.016 28.48 15.975 29 18 29c6.627 0 12-5.373 12-12S22.627 3 16 3zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10c-1.822 0-3.53-.5-4.99-1.365l-.356-.213-4.7.824.85-4.572-.232-.375C5.557 18.188 5 16.65 5 15 5 9.477 10.477 5 16 5zm-4.04 4.75c-.202 0-.52.074-.792.37-.272.296-1.04 1.015-1.04 2.469s1.06 2.864 1.22 3.079c.162.215 2.09 3.183 5.073 4.454.715.305 1.273.484 1.71.617.72.22 1.372.186 1.89.11.58-.083 1.78-.73 2.04-1.43.26-.7.26-1.316.19-1.437-.07-.12-.277-.196-.575-.337-.298-.14-1.75-.87-2.02-.97-.27-.1-.47-.144-.668.14-.198.283-.786.942-.958 1.128-.17.186-.334.202-.624.067-.29-.135-1.24-.46-2.37-1.485-.88-.798-1.49-1.783-1.66-2.082-.17-.3-.02-.466.124-.61.122-.12.3-.33.447-.5.147-.17.2-.294.308-.49.108-.196.053-.368-.022-.512-.075-.143-.683-1.64-.94-2.236-.256-.595-.503-.52-.682-.52z" fill="#fff"/></svg>
          Enviar no WhatsApp
        </button>
      </div>
    </div>
  </div>

  <script>
  (()=>{
    'use strict';

    /* ===== DADOS (ajustados conforme sua lista) ===== */
    const DATA = {
      encarregados:[
        {nome:'Severo (Hidráulica)', tarefas:[
          {codigo:'T-0313', titulo:'Rede hidráulica de entrada de água — conclusão', prazo_esperado:'19/09/2025', status:'exec', pct:85, obs:'Madeiras e paletes no caminho obstruído (almoxarifado da Asas).'},
          {codigo:'T-0314', titulo:'Troca do suporte da rede Ø110 mm: perfilado → cantoneira (recalque de pluviais e esgoto)', prazo_esperado:'19/09/2025', status:'exec', pct:90, obs:'Madeiras e paletes no caminho obstruído (almoxarifado da Asas).'},
          {codigo:'T-0322', titulo:'Retrabalho de 7 caixas de rede externa, reposicionamento de tubulações e acabamento — aditivo', prazo_esperado:'26/09/2025', status:'exec', pct:20, obs:'Pendente: 6 peças de tubo Ø200 solicitadas por transferência.'},
          {codigo:'T-0323', titulo:'Montagem de conjuntos de bombas em 3 poços', prazo_esperado:'26/09/2025', status:'', pct:0, obs:'Falta de material: joelho 90° × 60 soldável. Início previsto com desvio de rede no subsolo do Bloco 3 (obstrução da porta).'},
          {codigo:'T-0329', titulo:'Rede de poços — tubo Ø110 mm (poços)', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'},
          {codigo:'T-0330', titulo:'Águas pluviais — poços 07, 08 e 11', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'},
          {codigo:'T-0331', titulo:'Águas servidas — poços 07 e 18', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'}
        ]},
        {nome:'Airton (Hidráulica)', tarefas:[
          {codigo:'T-0305', titulo:'Entrega de apartamentos para a Qualidade — Blocos 2 e 3 — 1º ao 4º pavimentos', prazo_esperado:'19/09/2025', status:'done', pct:100, data_conclusao:'19/09/2025'},
          {codigo:'T-0306', titulo:'Instalação da redutora de pressão — 8º pavimento — Bloco 3', prazo_esperado:'19/09/2025', status:'exec', pct:100},
          {codigo:'T-0324', titulo:'Entrega de apartamentos — 4º ao 6º pavimentos dos Blocos 2 e 3', prazo_esperado:'26/09/2025', status:'', pct:0, obs:'Segue sem avanço.'},
          {codigo:'T-0325', titulo:'Execução da redutora de pressão — 12º pavimento do Bloco 3', prazo_esperado:'26/09/2025', status:'', pct:10}
        ]},
        {nome:'Thiago (Elétrica)', tarefas:[
          {codigo:'T-0315', titulo:'Tratamento de todas as eletrocalhas', prazo_esperado:'19/09/2025', status:'done', pct:100, data_conclusao:'19/09/2025'},
          {codigo:'T-0317', titulo:'Instalação de 5 quadros de bombas', prazo_esperado:'19/09/2025', status:'done', pct:100, data_conclusao:'18/09/2025'},
          {codigo:'T-0316', titulo:'Instalação de luminárias — trecho central do subsolo (±50 unidades em zonas apagadas)', prazo_esperado:'19/09/2025', status:'exec', pct:100},
          {codigo:'T-0321', titulo:"Instalação de CSMD's dos blocos 1, 2 e 3", prazo_esperado:'26/09/2025', status:'exec', pct:30},
          {codigo:'T-0338', titulo:'Infra no subsolo para automático de boia das torres', prazo_esperado:'26/09/2025', status:'', pct:0, obs:'Janela: 22/09 a 26/09.'},
          {codigo:'T-0339', titulo:'Montagem de eletrocalha 200×150 para comandos — trecho central do subsolo', prazo_esperado:'26/09/2025', status:'', pct:0, obs:'Janela: 22/09 a 26/09.'},
          {codigo:'T-0340', titulo:'Montagem de perfilado 38×38 para iluminação do espelho d’água 2', prazo_esperado:'26/09/2025', status:'', pct:0, obs:'Janela: 22/09 a 26/09.'},
          {codigo:'T-0337', titulo:'Instalação de 100 luminárias — trecho entre a casa de bombas e o espelho d’água', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'}
        ]},
        {nome:'Marcelo (Elétrica)', tarefas:[
          {codigo:'T-0318', titulo:'Entrega de apartamentos', prazo_esperado:'19/09/2025', status:'exec', pct:80},
          {codigo:'T-0319', titulo:'Fechamento de QDLs dos apartamentos — 19º e 20º (duas torres)', prazo_esperado:'19/09/2025', status:'block', pct:40, obs:"Aguardando materiais (componentes para QDL's)"},
          {codigo:'T-0320', titulo:'SPDA das duas torres (executar áreas liberadas)', prazo_esperado:'19/09/2025', status:'exec', pct:30},
          {codigo:'T-0326', titulo:'Instalação das tampas dos barramentos blindados verticais — 3 torres', prazo_esperado:'26/09/2025', status:'', pct:50},
          {codigo:'T-0327', titulo:'Ensaios/funcionais dos barramentos blindados', prazo_esperado:'26/09/2025', status:'', pct:33},
          {codigo:'T-0328', titulo:'Instalação dos cofres pendentes', prazo_esperado:'26/09/2025', status:'', pct:33},
          {codigo:'T-0332', titulo:'Lançamento de cabos — Bomba de recalque Bloco 1', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'},
          {codigo:'T-0333', titulo:'Lançamento de cabos — Bomba de recalque Bloco 2', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'},
          {codigo:'T-0334', titulo:'Lançamento de cabos — Bomba de recalque Bloco 3', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'},
          {codigo:'T-0335', titulo:'Passagem de fiação para os espelhos d’água 2 e 3', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'},
          {codigo:'T-0336', titulo:'Passagem/lançamento de cabos — poços de águas servidas 03A e 03B', prazo_esperado:'03/10/2025', status:'', pct:0, obs:'Janela: 29/09 a 03/10.'}
        ]}
      ],
      suprimentos:{
        compradores:['Brígida Souza','Suellen Mello','Lucas Fernandes'],
        pendencias_teams:{'Brígida Souza':0,'Suellen Mello':0,'Lucas Fernandes':0},
        requisicoes:[
          {codigo:'RQ-11305', numero:'RQ-11305', responsavel:'Brígida Souza', contrato:'Atlântico', material:'Condulete', aplicacao:'-', data:'', prazo:'', status:'Em cotação', obs:'Requisição atribuída para cotação'},
          {codigo:'RQ-11086', numero:'RQ-11086', responsavel:'Suellen Mello', contrato:'Atlântico', material:'Repastilhamento', aplicacao:'-', data:'', prazo:'', status:'', obs:'Fornecedor: TRIUNFO (LOC). Aguardando retorno da obra sobre disponibilidade de brocas para retirada'},
          {codigo:'RQ-11295', numero:'RQ-11295', responsavel:'Suellen Mello', contrato:'Atlântico', material:'Material de fixação', aplicacao:'-', data:'', prazo:'', status:'', obs:'OC 587 — 16/09 parcial'},
          {codigo:'RQ-11309', numero:'RQ-11309', responsavel:'Suellen Mello', contrato:'Atlântico', material:'Parafuso', aplicacao:'-', data:'', prazo:'', status:'', obs:'Fornecedor: PARAFUSOPAR. OC: system. Não chegou'},
          {codigo:'RQ-11181', numero:'RQ-11181', responsavel:'Suellen Mello', contrato:'Atlântico', material:'PVC', aplicacao:'Ralos embasamento / fechamento de bombas', data:'', prazo:'', status:'', obs:'OC 597 — 18/09 parcial'},
          {codigo:'RQ-10623', numero:'RQ-10623', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'Quadros de entrada de energia', aplicacao:'Entrada de energia', data:'', prazo:'', status:'', obs:'OC 009 — 09/09 parcial; restante 25/09'},
          {codigo:'RQ-11282', numero:'RQ-11282', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'Tê de fachada', aplicacao:'Fachada', data:'', prazo:'', status:'', obs:'OC 591 — não chegou'},
          {codigo:'RQ-11237', numero:'RQ-11237', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'Fitas isolantes', aplicacao:'Elétrica força e distribuição', data:'', prazo:'', status:'', obs:'OC 585 — chegou 16/09'},
          {codigo:'RQ-11238', numero:'RQ-11238', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'Ralo + PVC', aplicacao:'Distribuição hidráulica térreo', data:'', prazo:'', status:'', obs:'OC 595 — entrega parcial 19/09'},
          {codigo:'RQ-11333', numero:'RQ-11333', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'Tê de fachada', aplicacao:'Fachada', data:'', prazo:'', status:'', obs:'OC 593 — Chegou'},
          {codigo:'RQ-11314', numero:'RQ-11314', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'Fitas isolantes', aplicacao:'Elétrica força e distribuição', data:'', prazo:'', status:'', obs:'OC 590 — 17/09/2025'},
          {codigo:'RQ-11291', numero:'RQ-11291', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'PIAL PLUS+', aplicacao:'Áreas comuns / subsolo / escadas / coberturas / extravios', data:'', prazo:'', status:'Em cotação', obs:'Requisição atribuída para cotação'},
          {codigo:'RQ-11294', numero:'RQ-11294', responsavel:'Lucas Fernandes', contrato:'Atlântico', material:'Arandelas', aplicacao:'Escadas e áreas técnicas', data:'', prazo:'', status:'Em cotação', obs:'Requisição atribuída para cotação'}
        ],
        ocs:[
          {codigo:'OC-587', numero:'OC-587', emissao:'', fornecedor:'WALSYWA Comércio de Produtos Metalúrgicos Ltda', status:'EMITIDA', previsao:'', comprador:'Suellen', recebido:'16/09/2025', origem_rq:'RQ-11295', material:'Material de fixação', aplicacao:'-', obs_comprador:'Parcial'},
          {codigo:'OC-597', numero:'OC-597', emissao:'', fornecedor:'KG Instalações e Com. Elétrico', status:'EMITIDA', previsao:'', comprador:'Suellen', recebido:'18/09/2025', origem_rq:'RQ-11181', material:'PVC', aplicacao:'Ralos/fechamentos', obs_comprador:'Parcial'},
          {codigo:'OC-009', numero:'OC-009', emissao:'', fornecedor:'ELETROASA — Eletrometalúrgica ASA Eireli', status:'EMITIDA', previsao:'25/09/2025', comprador:'Lucas', recebido:'09/09/2025', origem_rq:'RQ-10623', material:'Quadros de entrada de energia', aplicacao:'Entrada de energia', obs_comprador:'Entrega parcial 09/09; restante 25/09'},
          {codigo:'OC-591', numero:'OC-591', emissao:'', fornecedor:'Westaflex Tubos Flexíveis Ltda', status:'EMITIDA', previsao:'', comprador:'Lucas', recebido:'', origem_rq:'RQ-11282', material:'Tê de fachada', aplicacao:'Fachada', obs_comprador:'Não chegou'},
          {codigo:'OC-585', numero:'OC-585', emissao:'', fornecedor:'Lukma', status:'EMITIDA', previsao:'', comprador:'Lucas', recebido:'16/09/2025', origem_rq:'RQ-11237', material:'Fita isolante', aplicacao:'Elétrica força e distribuição'},
          {codigo:'OC-595', numero:'OC-595', emissao:'', fornecedor:'KG Instalações e Comércio Elétrico Ltda', status:'EMITIDA', previsao:'', comprador:'Lucas', recebido:'19/09/2025', origem_rq:'RQ-11238', material:'Ralo + PVC', aplicacao:'Distribuição hidráulica térreo', obs_comprador:'Entrega parcial'},
          {codigo:'OC-593', numero:'OC-593', emissao:'', fornecedor:'Mosal Artefatos de Alumínio Ltda - ME', status:'recebido', previsao:'', comprador:'Lucas', recebido:'', origem_rq:'RQ-11333', material:'Tê de fachada', aplicacao:'Fachada', obs_comprador:'Chegou'},
          {codigo:'OC-590', numero:'OC-590', emissao:'', fornecedor:'Lukma', status:'EMITIDA', previsao:'17/09/2025', comprador:'Lucas', recebido:'', origem_rq:'RQ-11314', material:'Fitas isolantes', aplicacao:'Elétrica força e distribuição'}
        ]
      }
    };

    /* ===== Utils ===== */
    const DAY=86400000, HOUR=36e5;
    const $ = sel => document.querySelector(sel);
    const el = (tag, cls, text) => { const e=document.createElement(tag); if(cls) e.className=cls; if(text!=null) e.textContent=text; return e };
    const pad = n => String(n).padStart(2,'0');
    const parseBRDate = s => { if(!s) return null; const a=s.split('/'); if(a.length!==3) return null; const [d,m,y]=a.map(Number); const dt=new Date(y,(m||1)-1,d||1,12,0,0); return isNaN(dt)?null:dt };
    const dLabel = s => { const d=parseBRDate(s); if(!d) return ''; const delta=Math.floor((d - new Date())/DAY); return delta===0? 'D-0' : (delta>0? 'D-'+delta : 'D+'+Math.abs(delta)); };
    const isPastDue = s => { const d=parseBRDate(s); return !!(d && (new Date() - d) > 0); };
    const urgencyByDate = (dateStr,status)=>{
      if(status==='done'||status==='FINALIZADA') return 'done';
      if(isPastDue(dateStr)) return 'overdue';
      if(status==='recebido') return 'recv';
      if(status==='block') return 'block';
      if(status==='exec') return 'exec';
      const d=parseBRDate(dateStr); if(!d) return 'ok';
      const h=(d-new Date())/HOUR; return (h<=48)?'soon':'ok';
    };
    const compareByPrazo = (a,b)=>{
      const u = ds => { const d=parseBRDate(ds); if(!d) return 3; const h=(d-new Date())/HOUR; return (h<=0)?0:(h<=48?1:2) };
      const aDate=a.prazo_esperado||a.prazo||a.previsao||a.data||'';
      const bDate=b.prazo_esperado||b.prazo||b.previsao||b.data||'';
      const ua=u(aDate), ub=u(bDate);
      if(ua!==ub) return ua-ub;
      const da=parseBRDate(aDate), db=parseBRDate(bDate);
      if(da&&db) return da-db; if(da&&!db) return -1; if(!da&&db) return 1; return 0;
    };
    const compareOC = (a,b)=>{
      const ar=!!a.recebido, br=!!b.recebido; if(ar!==br) return (br - ar);
      if(ar&&br){ const da=parseBRDate(a.recebido), db=parseBRDate(b.recebido); if(da&&db) return db-da; if(da&&!db) return -1; if(!da&&db) return 1; }
      return compareByPrazo({previsao:a.previsao,status:a.status},{previsao:b.previsao,status:b.status});
    };

    /* ===== Share helpers ===== */
    function formatStatus(status, dueStr){
      if(status==='exec') return 'Em execução';
      if(status==='block') return 'Bloqueada';
      if(status==='done'||status==='FINALIZADA') return 'Finalizada';
      return isPastDue(dueStr)?'Atrasada':'Pendente';
    }
    function nowStamp(){
      const d = new Date();
      const dd = pad(d.getDate()), mm = pad(d.getMonth()+1), yyyy=d.getFullYear();
      const hh = pad(d.getHours()), mi = pad(d.getMinutes());
      return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
    }
    function buildTaskMessage(t, encarregado, note){
      const due = t.prazo_esperado||t.prazo||'-';
      const status = formatStatus(t.status, due);
      const pct = Math.max(0, Math.min(100, Number(t.pct||0)));
      const header = `*${t.codigo||''} — ${t.titulo}*`;
      const body = [
        `Responsável: ${encarregado}`,
        `Status: ${status} • Avanço: ${pct}%`,
        `Prazo: ${due}${due? ` (${dLabel(due)})`:''}`,
        t.obs? `Obs.: ${t.obs}`: null,
      ].filter(Boolean).join('\n');
      const stamp = nowStamp();
      const comment = `*Comentário (${stamp}):* ${note}`;
      return `${header}\n${body}\n\n${comment}`;
    }
    function openWhatsAppWithText(text){
      const enc = encodeURIComponent(text);
      const isMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
      const deeplink = `whatsapp://send?text=${enc}`; // mobile apps
      const web = `https://wa.me/?text=${enc}`;       // web/desktop
      if(isMobile){
        const w = window.open(deeplink, '_blank');
        setTimeout(()=>{ if(!w || w.closed) window.open(web, '_blank'); }, 600);
      } else {
        window.open(web, '_blank');
      }
    }

    /* ===== Modal ===== */
    const modal = $('#shareModal');
    const noteEl = $('#shareNote');
    const sendBtn = $('#shareSend');
    const cancelBtn = $('#shareCancel');
    let shareCtx = null; // {t, enc}
    function openModal(ctx){ shareCtx = ctx; noteEl.value=''; modal.classList.add('open'); noteEl.focus(); }
    function closeModal(){ modal.classList.remove('open'); shareCtx=null; }
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

    sendBtn.addEventListener('click', ()=>{
      if(!shareCtx) return;
      const note = noteEl.value.trim();
      if(!note){ noteEl.focus(); noteEl.setCustomValidity('Digite uma nota.'); noteEl.reportValidity(); setTimeout(()=>noteEl.setCustomValidity(''), 800); return; }
      const msg = buildTaskMessage(shareCtx.t, shareCtx.enc, note);
      closeModal();
      openWhatsAppWithText(msg);
    });

    /* ===== Render ===== */
    const boardEl = $('#board');

    // NOVO: finalizados sempre no fim + auto concluir quando pct >= 100
    function isDone(t){ return t.status==='done' || t.status==='FINALIZADA' || Number(t.pct||0) >= 100; }

    function sortTasksWithDoneLast(a,b){
      const ad = isDone(a), bd = isDone(b);
      if(ad !== bd) return ad ? 1 : -1; // done vai pro fim
      return compareByPrazo(a,b);
    }

    function renderEncColumns(){
      for(const enc of DATA.encarregados){
        const col = el('section','column'); col.setAttribute('role','region'); col.setAttribute('aria-label',enc.nome);
        col.appendChild(el('h2','',enc.nome));
        const list = el('div','list');
        const tasks = (enc.tarefas||[]).slice().sort(sortTasksWithDoneLast);
        for(const t of tasks){
          const pct = Math.max(0, Math.min(100, Number(t.pct||0)));
          if(pct>=100 && !(t.status==='done'||t.status==='FINALIZADA')) t.status='done'; // auto-concluir 100%
          const dueStr = t.prazo_esperado||t.prazo||'';
          const card = el('article', 'task '+urgencyByDate(dueStr,t.status));

          const header = el('div','');
          header.appendChild(el('span','code','#'+(t.codigo||'')));
          const title = el('span','title'); title.textContent = t.titulo; header.appendChild(title);

          const btn = document.createElement('button');
          btn.className='share-btn'; btn.type='button'; btn.title='Compartilhar no WhatsApp'; btn.setAttribute('aria-label','Compartilhar no WhatsApp');
          btn.innerHTML = '<svg class="wa-ico" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 3C9.373 3 4 8.373 4 15c0 2.11.548 4.09 1.504 5.82L4 29l8.332-1.46C14.016 28.48 15.975 29 18 29c6.627 0 12-5.373 12-12S22.627 3 16 3zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10c-1.822 0-3.53-.5-4.99-1.365l-.356-.213-4.7.824.85-4.572-.232-.375C5.557 18.188 5 16.65 5 15 5 9.477 10.477 5 16 5zm-4.04 4.75c-.202 0-.52.074-.792.37-.272.296-1.04 1.015-1.04 2.469s1.06 2.864 1.22 3.079c.162.215 2.09 3.183 5.073 4.454.715.305 1.273.484 1.71.617.72.22 1.372.186 1.89.11.58-.083 1.78-.73 2.04-1.43.26-.7.26-1.316.19-1.437-.07-.12-.277-.196-.575-.337-.298-.14-1.75-.87-2.02-.97-.27-.1-.47-.144-.668.14-.198.283-.786.942-.958 1.128-.17.186-.334.202-.624.067-.29-.135-1.24-.46-2.37-1.485-.88-.798-1.49-1.783-1.66-2.082-.17-.3-.02-.466.124-.61.122-.12.3-.33.447-.5.147-.17.2-.294.308-.49.108-.196.053-.368-.022-.512-.075-.143-.683-1.64-.94-2.236-.256-.595-.503-.52-.682-.52z" fill="#fff"/>';
          btn.addEventListener('click', (e)=>{ e.stopPropagation(); openModal({t, enc: enc.nome}); });

          const meta = el('div','meta-text');
          const parts = [];
          let p1 = 'Prazo esperado: '+(dueStr||'-');
          if(t.status!=='done' && t.status!=='FINALIZADA') p1 += ' • '+dLabel(dueStr||'');
          parts.push(p1);
          if(t.obs) parts.push('Obs.: '+t.obs);
          meta.innerHTML = parts.map(p=>`<div>${p}</div>`).join('');

          let statusLabel='Pendente';
          if(t.status==='exec') statusLabel='Em execução'; else if(t.status==='block') statusLabel='Bloqueada'; else if(t.status==='done'||t.status==='FINALIZADA') statusLabel='Finalizada 🏆'; else if(card.className.includes('overdue')) statusLabel='Atrasada';
          const chip = el('span','chip',statusLabel); meta.appendChild(chip);

          const pWrap = el('div','progress'); const pBar = el('div','progress-inner'); pBar.style.width = pct+'%'; pWrap.appendChild(pBar);
          const pLabel = el('div','progress-label'); pLabel.appendChild(el('span','', 'Avanço: '+pct+'%'));

          card.appendChild(header); card.appendChild(meta); card.appendChild(pWrap); card.appendChild(pLabel); card.appendChild(btn);
          list.appendChild(card);
        }
        col.appendChild(list); boardEl.appendChild(col);
      }
    }

    function renderSuppliesColumn(){
      const sup = DATA.suprimentos || {}; const rqs=(sup.requisicoes||[]).slice(); const ocs=(sup.ocs||[]).slice();
      rqs.sort((a,b)=>compareByPrazo(a,b)); ocs.sort(compareOC);
      const col = el('section','column'); col.setAttribute('role','region'); col.setAttribute('aria-label','Suprimentos');
      col.appendChild(el('h2','', 'Suprimentos'));
      const list = el('div','list');

      // Requisições
      const rqHdr = el('div','title','Requisições em Aberto'); list.appendChild(rqHdr);
      for(const rq of rqs){
        const it = el('article','item '+urgencyByDate(rq.prazo, rq.status));
        const rowTop=el('div','row'); const left=el('div');
        left.appendChild(el('span','code','#'+(rq.codigo||rq.numero||''))); left.appendChild(el('strong','',rq.numero||rq.codigo||'RQ'));
        rowTop.appendChild(left); rowTop.appendChild(el('span','',rq.status||''));
        const kv1=el('div','kv','Data: '+(rq.data||'-')+' • Prazo: '+(rq.prazo||'-'));
        const kv2=el('div','kv','Resp.: '+(rq.responsavel||'-')+' • Contrato: '+(rq.contrato||'-')+' • Material: '+(rq.material||'-'));
        const kv3=el('div','kv','Aplicação: '+(rq.aplicacao||'-')+' • Obs.: '+(rq.obs||'-'));
        it.appendChild(rowTop); it.appendChild(kv1); it.appendChild(kv2); it.appendChild(kv3);
        list.appendChild(it);
      }

      // OCs
      const ocHdr = el('div','title','Ordens de Compra (OC)'); list.appendChild(ocHdr);
      for(const oc of ocs){
        const cls = oc.recebido? 'recv' : urgencyByDate(oc.previsao, oc.status);
        const it2 = el('article','item '+cls);
        const rowTop2=el('div','row'); const left2=el('div');
        left2.appendChild(el('span','code','#'+(oc.codigo||oc.numero||''))); left2.appendChild(el('strong','',oc.numero||oc.codigo||'OC'));
        rowTop2.appendChild(left2); rowTop2.appendChild(el('span','',oc.status||''));
        const kv3=el('div','kv','Fornecedor: '+(oc.fornecedor||'-')+' • Comprador: '+(oc.comprador||'-')+' • Origem: '+(oc.origem_rq||'-'));
        const kv4=el('div','kv','Material: '+(oc.material||'-')+' • Aplicação: '+(oc.aplicacao||'-'));
        const kv5=el('div','kv','Emissão: '+(oc.emissao||'-')+' • Previsão: '+(oc.previsao||'-'));
        const st=el('div','kv', oc.recebido?('Recebido em '+oc.recebido):'Pendente');
        it2.appendChild(rowTop2); it2.appendChild(kv3); it2.appendChild(kv4); it2.appendChild(kv5); it2.appendChild(st);
        if(oc.obs_comprador) it2.appendChild(el('div','kv','Obs. comprador: '+(oc.obs_comprador||'')));
        list.appendChild(it2);
      }

      col.appendChild(list); boardEl.appendChild(col);
    }

    function render(){
      boardEl.innerHTML='';
      renderEncColumns();
      renderSuppliesColumn();
    }

    function pad2(n){return String(n).padStart(2,'0')}
    function fmtClock(){ const t=new Date(); return `${pad2(t.getHours())}:${pad2(t.getMinutes())}:${pad2(t.getSeconds())}` }
    function setStamp(){ const d=new Date(); const stamp=`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; document.getElementById('stamp').textContent=stamp; }

    document.addEventListener('DOMContentLoaded', ()=>{
      render();
      setStamp();
      document.getElementById('clock').textContent = fmtClock();
      setInterval(()=>document.getElementById('clock').textContent = fmtClock(), 1000);
    });
  })();
  </script>
</body>
</html>
